---
lang: it-IT
title: "DESeq2 - Analysing RNA-seq data"
subtitle: "Tesina per il corso di Statistica Applicata e Analisi dei Dati A.A. 2024/2025"
author: "Claudia Costa, matr. 153256"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  bookdown::pdf_document2:
    toc: no
    toc_depth: 3
    number_sections: true
    includes:
      in_header: "preamble.tex"
fontsize: 10pt
bibliography: references.bib
csl: bib.csl
nocite: '@*'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\tableofcontents

\listoffigures

\newpage

# Introduzione

In questa tesina viene descritto il pacchetto \href{https://www.bioconductor.org/packages/release/bioc/html/DESeq2.html}{DESeq2} \href{https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html}{(vignetta)} [@deseq2], uno strumento specifico per l'analisi dell'espressione differenziale genica basata sulla distribuzione binomiale negativa.
Il pacchetto fa parte di \href{https://www.bioconductor.org/}{Bioconductor}, un progetto che mira a sviluppare e condividere software open source per l'analisi dati biologici.

La tesina è strutturata in tre parti principali: nella prima viene introdotta la teoria alla base dell'analisi dell'espressione differenziale genica; nella seconda si approfondiscono le caratteristiche del pacchetto DESeq2 e i [principi teorici](#teoria) su cui si basa; nella terza parte, infine, viene presentato un esempio pratico dell'utilizzo di DESeq2, applicato ad un dataset di RNA-seq dello \href{https://pubmed.ncbi.nlm.nih.gov/25464849/}{studio} al [@kenny2014mov10; @example].


# Analisi dell'espressione differenziale

## Introduzione

### Che cosa è un gene?

Un gene è l'unità fondamentale di informazione genetica contenuta nel DNA, che codifica per una proteina o un RNA funzionale (ad esempio RNA ribosomiale o microRNA).  

Nei geni codificanti, l'informazione genetica viene trascritta in RNA messaggero (mRNA) e successivamente tradotta in proteine, che svolgono funzioni essenziali per il metabolismo, la struttura e la comunicazione cellulare.
Nei geni non codificanti, l'RNA prodotto ha ruoli regolatori o strutturali.

I geni non sono espressi in modo uniforme: la loro attività, denominata espressione, varia tra tipi di cellule, condizioni ambientali, stati di sviluppo e risposte a stimoli, contribuendo alla diversità biologica e alla funzione specifica dei tessuti.

### Che cosa è l'espressione genica?

L'**espressione genica** si riferisce al processo attraverso il quale un gene viene attivato per generare il suo prodotto funzionale. Questo processo può essere suddiviso in due fasi principali:
\begin{enumerate}
    \item Trascrizione: DNA viene copiato in mRNA.
    \item Traduzione: mRNA viene utilizzato come stampo per la sintesi proteica.
\end{enumerate}

L'espressione genica può essere misurata come la quantità di mRNA prodotto (livello trascrizione) o la quantità della proteina risultante (livello traduzione).

Capire come i geni vengono espressi in condizioni diverse aiuta a rispondere a domande biologiche fondamentali, come, ad esempio, quali geni sono coinvolti in una malattia e quali effetti ha un farmaco su una popolazione cellulare.

L'analisi dell'espressione differenziale, quindi, cerca di identificare quali geni hanno un'espressione significativamente diversa tra gruppi differenti (es. cellule sane vs malate, prima e dopo un trattamento, ecc.).


## Concetti di base dell’analisi dell'espressione differenziale

L'analisi dell'espressione differenziale è una tecnica bioinformatica utilizzata per confrontare l'attività di migliaia di geni tra due o più condizioni sperimentali. Si basa sui dati di RNA-seq, che misurano quantitativamente l'espressione genica. Questo significa che, per ciascun gene viene determinato un valore numerico, chiamato count, il quale rappresenta la quantità di mRNA prodotto, fornendo così un'indicazione precisa del livello di attività di quel gene in un dato campione. Un esempio del processo di RNA-seq è mostrato in figura \@ref(fig:RNAseq).

\begin{figure}[h]
    \centering
    \includegraphics[width=0.75\linewidth]{RNAseq.png}
    \caption{Processo di RNA sequencing. Esempio giocattolo in cui il genoma è costituito da soli cinque geni specificati dai colori rosso, blu, viola, verde e arancione. Si parte isolando l'RNA totale dalle cellule, che rappresenta le molecole attive in un determinato momento. Successivamente, l'RNA viene frammentato e convertito in cDNA attraverso la retrotrascrizione. Per prepararlo al sequenziamento, vengono aggiunti adattatori specifici alle estremità del cDNA. Il materiale così preparato viene quindi sottoposto ad una piattaforma di sequenziamento ad alta capacità, che legge le sequenze nucleotidiche dei frammenti. Una volta ottenute queste sequenze (chiamate reads), vengono allineate al genoma di riferimento per identificarne l'origine. Infine, i reads mappati su ciascun gene vengono conteggiati per quantificare il livello di espressione di ogni gene.}
    \label{fig:RNAseq}
\end{figure}

L'obiettivo principale è **l'identificazione dei geni con espressione significativamente diversa tra condizioni**, quantificando l'entità del cambiamento e valutandone la rilevanza statistica per distinguere variazioni reali dal caso.

<!-- In altre parole, si vuole confrontare due condizioni biologicamente distinte con l'obiettivo di identificare i geni che presentano schemi di espressione diversi tra queste condizioni a causa di fenomeni biologici. -->

<!-- Supponiamo di voler studiare l'effetto di un farmaco con il suo potenziale di essere usato come terapia antitumorale e di volerne testare l'efficacia, quindi estraiamo i tumori dai pazienti e li inoculiamo in sei topi, tre dei quali hanno ricevuto il trattamento e tre no, in ciascuna condizione. 
Questo è un tipico esperimento in cui, in ogni condizione, ci sono repliche biologiche. -->

### Caratteristiche e distribuzione dei dati di counts

In un esperimento di sequenziamento dell'RNA, dopo che le reads sono state sequenziate e quantificate, il risultato che si ottiene è una matrice $K$ in cui le righe sono i geni e le colonne sono i campioni. Questi counts rappresentano il **numero di reads mappate per quel gene in quel campione**.


Semplici controlli sulla distribuzione, come quello mostrato in figura \@ref(fig:distribuzioneCounts), evidenziano che i dati dei counts non seguono una distribuzione normale. Una possibile alternativa potrebbe essere la distribuzione di Poisson, che descrive il numero di eventi che si verificano in un dato intervallo di tempo o spazio. Tuttavia, questa distribuzione presume che la media e la varianza siano uguali (parametro \(\lambda\)), una condizione che non si verifica nei dati di RNA-seq, dove la varianza è spesso maggiore della media. Di conseguenza, la distribuzione di Poisson non è adeguata per descrivere tali dati.


Si può immaginare un processo teorico in cui il genoma viene esplorato casualmente per generare reads, un esempio che rientra nella definizione di distribuzione di Poisson. Tuttavia, nei dati reali di RNA-seq, esistono variazioni biologiche aggiuntive che non possono essere catturate da un modello di Poisson, rendendo necessario ricorrere a modelli più complessi, come la distribuzione binomiale negativa [-@biostars_negative_binomial].


La distribuzione binomiale negativa è progettata per situazioni in cui la varianza supera la media ed è definita da due parametri: la media \(\mu\), che rappresenta il livello di espressione medio del gene e la dispersione \(\alpha\), che indica quanto i conteggi si discostano dalla media e consente di modellare la variabilità extra che viene generata nei dati di RNA-seq [-@bioconductor_negative_binomial; -@negative_binomial_wikipedia].
Questo concetto è illustrato nella figura \@ref(fig:meanvariance).



### Importanza biologica della DEA
L'analisi dell'espressione differenziale fornisce un quadro chiaro dei processi molecolari che distinguono una condizione da un’altra. Questo è fondamentale in numerosi contesti:
\begin{itemize}
    \item[-] ricerca medica: identificare geni responsabili di malattie o geni alterati in condizioni patologiche;
    \item[-] ricerca farmaceutica: determinare quali geni rispondono a un trattamento;
    \item[-] biologia dello sviluppo: studiare le variazioni geniche durante il differenziamento cellulare;
    \item[-] ecologia e biologia evolutiva: analizzare l'espressione genica in risposta a stress ambientali. 
\end{itemize}


\newpage

# DESeq2

## Teoria pacchetto {#teoria}
<!-- Estimate variance-mean dependence in count data from high-throughput sequencing assays and test for differential expression based on a model using the negative binomial distribution. -->

DESeq2 esegue gli step riportati nella figura \ref{fig:workflow} per identificare se un insieme di geni è differenzialmente espresso o no. Tutti i passaggi in blu sono eseguiti automaticamente dalla funzione \texttt{DESeq()} e sono descritti nelle sezioni successive.
<!--
\begin{itemize}
    \item stima size factor
    \item stima dispersione
    \item fit modello lineare GLM
    \item test ipotesi con test di Wald
\end{itemize}

Tutti questi step sono eseguiti dalla funzione \texttt{DESeq()} e sono riportati nella figura \ref{fig:workflow}. -->

\begin{figure}
    \centering
    \includegraphics[width=0.45\linewidth]{DESeq2_workflow_2018.png}
    \caption{Workflow di DESeq2. I box della colonna a sinistra corrispondono alle lettere, mentre quelli di destra ai numeri romani. (A) modellazione counts grezzi per ogni gene (i) normalizzazione dei counts stimando i size factors; (ii) stima della dispersione dei geni; (iii) adattamento curva di dispersione; (iv) riduzione stime di dispersione; (v) adattamento GLM per ogni gene; (B) riduzione stime log2 fold changes; (C) test per l'espressione differenziale.}
    \label{fig:workflow}
\end{figure}

Il punto di partenza di un'analisi DESeq2 è una matrice $K$ dei counts di dimensione $n\times m$, dove $i=1,...,n$ indicizza i geni e $j=1,...,m$ indicizza i campioni. L'entry della matrice $K_{ij}$ indica il numero di read counts che sono stati mappati sul gene $i$ nel campione $j$.



### Stima size factor - metodo median of ratios {#stimaSF}

Bisogna innanzitutto normalizzare i dati dei counts, per permettere un corretto confronto tra i geni. Per fare ciò è necessario calcolare i size factors. Il size factor $s_{ij}$ è un fattore di scala che tiene conto della profondità di sequenziamento e della composizione del campione; all'interno del campione $i$ sono considerati costanti: $s_{ij} = s_j$.

Il size factor viene calcolato impiegando tre passaggi principali:
\begin{enumerate}
    \item si calcola la media geometrica per ciascun gene (geometrica perché è più robusta agli outliers rispetto a quella aritmetica): $(\prod_{v=1}^{m} K_{iv})^{1/m}$;
    \item si dividono i counts per la media geometrica: $\frac{K_{ij}}{(\prod_{v=1}^{m} K_{iv})^{1/m}}$;
    \item si calcola la mediana dei rapporti (calcolati nello step 2): \(\median\limits_i \frac{K_{ij}}{(\prod_{v=1}^{m} K_{iv})^{1/m}}\).
\end{enumerate}

Formalmente: \(s_j = \median\limits_i \frac{K_{ij}}{(\prod_{v=1}^{m} K_{iv})^{1/m}}\)
<!-- formula di DESeq -->


Infine, per normalizzare i dati, si divide ogni counts per il size factor corrispondente.


### Stima dispersione per ogni gene
<!-- for low mean counts, the variance estimates have a much larger spread; therefore, the dispersion estimates will differ much more between genes with small means. -->

<!-- dispersion of 0.01 = 10% of variability between replicates -->

La variabilità all'interno dei replicati è modellata dal parametro di dispersione \(\alpha_i\), che descrive la varianza dei counts secondo la formula \(\text{Var} \; K_{ij} = \mu_{ij} + \alpha_i \mu_{ij}^2\). Questo parametro $\alpha$ rappresenta quanto ci si può aspettare che un count osservato si discosti dal valore medio atteso (\(\mu_{ij}\)). Una stima accurata della dispersione è fondamentale per l'inferenza statistica nell'analisi dell'espressione differenziale, poiché campioni di piccole dimensioni possono portare a stime altamente variabili per ciascun gene.


Il grafico della media rispetto alla varianza nei dati di counts in figura \ref{fig:meanvariance} mostra che la varianza dell'espressione genica aumenta con l'espressione media (ogni punto nero è un gene). Si noti che la relazione tra media e varianza è lineare sulla scala logaritmica e che per medie più elevate è possibile prevedere la varianza in modo relativamente accurato in base alla media. Tuttavia, per medie basse, le stime della varianza hanno una dispersione molto più ampia; pertanto, le stime della dispersione differiranno molto di più tra geni con medie piccole.

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.4\linewidth]{deseq_mean_vs_variance.png}
    \caption{Plot della media vs varianza dei counts.}
    \label{fig:meanvariance}
\end{figure}


Per affrontare questo problema, vengono condivise informazioni tra i geni, presupponendo che quelli con livelli di espressione simili abbiano anche dispersioni simili.


Il processo di stima della dispersione inizia con una stima preliminare per ciascun gene, ottenuta utilizzando il metodo della massima verosimiglianza (MLE), basato esclusivamente sui dati relativi al gene stesso. Queste stime iniziali, però, possono essere imprecise o rumorose, specialmente per geni con counts bassi o con elevata dispersione.

Per ridurre il rumore e migliorare la precisione di queste stime, viene adattata una curva smooth (rappresentata dalla curva rossa in figura \ref{fig:dispersion}) che descrive il valore atteso della dispersione in funzione dell'espressione media. Questa curva fornisce un riferimento generale e riflette la dipendenza della dispersione dalla forza di espressione.

Successivamente, viene definita una distribuzione a priori per la dispersione, basata sull'adattamento della curva smooth e sulle proprietà osservate nei dati. La distribuzione a priori rappresenta le conoscenze iniziali o ipotesi sulla dispersione, fornendo un'idea del valore "plausibile" per ciascun gene in base alla media di espressione. Inoltre, controlla l'entità del restringimento (shrinkage), ovvero quanto le stime preliminari devono essere ristrette verso il valore previsto dalla curva.

Per concludere, le stime finali di dispersione (indicate dalle punte delle frecce blu) vengono aggiornate utilizzando il principio della massima a posteriori (MAP), che combina le informazioni della distribuzione a priori con i dati osservati. Questo restringimento spinge molte delle stime dei geni verso i valori previsti dalla curva adattata, riducendo l'impatto del rumore e minimizzando il rischio di falsi positivi causati da dispersioni sottostimate.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.65\linewidth]{dispersion.jpg}
    \caption{Stime di dispersione rispetto alla forza media di espressione.}
    \label{fig:dispersion}
\end{figure}

Non tutti i geni sono però soggetti a questo processo di regolarizzazione. Alcuni geni, evidenziati nella figura con un cerchio blu, mostrano una variabilità di dispersione così elevata che DESeq2 presume che non seguano le ipotesi del modello (il restringimento avrebbe seguito la linea tratteggiata). Per questi geni, è presente una variabilità aggiuntiva che non può essere spiegata dalla sola variazione biologica o tecnica.

Questo approccio bilancia la variabilità specifica di ciascun gene con la tendenza generale osservata nei dati. La forza del restringimento dipende da due fattori principali: (i) quanto i valori reali di dispersione tendano ad aderire alla curva stimata e (ii) i gradi di libertà. All'aumentare della dimensione del campione, il restringimento si riduce progressivamente fino a diventare trascurabile.

<!-- Questo metodo consente stime più robuste anche in contesti con informazioni limitate. Tuttavia, per geni con basse medie di espressione, le stime della varianza tendono a essere più ampie, portando a una maggiore variabilità tra le dispersioni stimate per questi geni. -->


<!--
In primo luogo, i MLE per gene sono ottenuti utilizzando solo i dati del rispettivo gene (punti neri). Quindi, una curva (rossa) viene adattata ai MLE per catturare la tendenza generale della dipendenza tra dispersione e media. Questo fit viene utilizzato come media precedente per un secondo ciclo di stima, che porta alle stime MAP finali della dispersione (teste delle frecce). Questo può essere inteso come un restringimento (lungo le frecce blu) delle stime rumorose dei geni verso il consenso rappresentato dalla linea rossa. I punti neri cerchiati in blu sono stati individuati come outlier di dispersione e non sono stati ridotti verso il priore (il restringimento avrebbe seguito la linea tratteggiata). -->

<!--
3 step:
\begin{enumerare}
    \item si ottiene la stima della dispersione per ogni gene usando la stima della massima verosimiglianza
    \item fittare una curva alle stime di dispersione dei geni in modo che questa curva rappresenti il valore atteso della dispersione dati i valori di espressione dei geni
    \item restringere le stime di dispersione dei geni verso i valori previsti dalla curva
\end{enumerate} -->

### Adattamento del modello

Le read counts $K_{ij}$ sono descritte con un modello lineare generalizzato (GLM), la quale famiglia è un'estensione dei modelli di regressione lineare. Questi modelli sono caratterizzati da una specifica distribuzione (non gaussiana) delle risposte e da una funzione di link, che trasferisce il valore medio in una scala in cui la relazione con le variabili esplicative è lineare e additiva, per consentire una forma più generale di espressione della risposta media.
In generale: $f\{E(Y_i)\} = \beta_0 + \beta_1 x_{i1} + \beta_2 x_{i2} + ... + \beta_p x_{ip}$, dove $f(\cdot)$ rappresenta la funzione di link e $\beta_0 + \beta_1 x_{i1} + \beta_2 x_{i2} + ... + \beta_p x_{ip}$ il predittore lineare.

Il GLM utilizzato fa parte della famiglia binomiale negativa, con media $\mu_{ij}$ e dispersione $\alpha_i$.
La media $\mu_{ij}=s_j \cdot q_{ij}$ è proporzionale alla concentrazione di frammenti cDNA del gene $i$ nel campione $j$: $q_{ij}$, scalata da un fattore di normalizzazione $s_j$.
Questo fattore di normalizzazione (sample specific size factor) equivale a quello descritto nella [sezione stima size factor](#stimaSF).


Per ogni gene viene quindi adattato un GLM con un link logaritmico $log_2(q_{ij})=\sum_r x_{jr} \cdot \beta_{ir}$, con $x_{jr}$ elementi della matrice di design e $\beta_{ir}$ coefficienti che rappresentano il log fold change (LFC). La matrice di design è una matrice $n \times (p+1)$ in cui ogni riga rappresenta una singola osservazione (dimensione $n$) e ogni colonna rappresenta una variabile esplicativa (dimensione $p$). La prima colonna aggiuntiva è il termine di intercetta.

<!-- Nel caso di un confronto tra due gruppi, come i campioni trattati e quelli di controllo, gli elementi della matrice del modello indicano se un campione $j$ è trattato o meno, e l'adattamento GLM restituisce coefficienti che indicano la forza di espressione complessiva del gene e il log2 fold change tra trattamento e controllo. -->


### Stima log fold change

Una delle difficoltà principali nell'analisi dell'espressione differenziale è la forte varianza (eteroschedasticità) delle stime del log fold change per geni con bassi read counts.

Il log fold change è una misura che descrive quanto cambia una quantità tra una misurazione originale e una successiva [-@wikipedia_fold_change]; in questo contesto **quantifica la differenza nell'espressione di un gene tra due condizioni**. In particolare, il fold change rappresenta il rapporto tra i livelli di espressione nelle due condizioni, mentre il logaritmo in base 2 di questo rapporto rende più gestibili i valori e simmetriche le variazioni. Si prenda ad esempio un LFC di \(+1\): esso indica un raddoppio dell'espressione in una condizione rispetto all'altra, mentre un LFC di \(-1\) indica una riduzione a metà.

DESeq2 supera il problema della forte varianza nelle stime del LFC restringendo queste ultime verso lo zero, in modo che il restringimento sia più marcato quando le informazioni disponibili per un gene sono limitate, ad esempio a causa di bassi conteggi, alta dispersione o pochi gradi di libertà.


Si inizia con l'adattamento di GLM per ottenere le stime di massima verosimiglianza dei LFC. Successivamente, una distribuzione normale centrata su zero viene adattata alla distribuzione delle MLE osservate su tutti i geni. Questa distribuzione normale viene utilizzata come distribuzione a priori, rappresentando le informazioni iniziali sui LFC prima di considerare i dati osservati ed è centrata su zero perché, a priori, si presume che la maggior parte dei geni non abbia variazioni significative nell'espressione genica, ovvero che il loro LFC sia vicino a zero.

Le stime finali dei LFC vengono calcolate applicando il principio della massima a posteriori, che combina la distribuzione a priori con le prove fornite dai dati osservati. Tale approccio consente di 'pesare' i dati osservati rispetto alla distribuzione a priori: se un gene mostra una variazione significativa, la stima finale si allontanerà da zero; altrimenti, sarà spinta verso il valore previsto a priori. Questa regolarizzazione è particolarmente utile per attenuare il rumore nei dati o quando il numero di campioni è limitato, rendendo le stime più robuste.

<!-- In sintesi: 
- La distribuzione a priori rappresenta cosa ci aspettiamo prima di vedere i dati.
- La distribuzione a posteriori incorpora sia le aspettative iniziali che le osservazioni reali per produrre una stima finale bilanciata.
-->

\begin{figure}[h!]
    \centering
    \includegraphics[width=0.45\linewidth]{LFCestimates.jpg}
    \caption{Effetto del restringimento sulle stime logaritmiche di fold change. Grafici della stima MLE (A) (cioè senza restringimento) e MAP (B) (cioè con restringimento) per le LFC, rispetto alla forza media di espressione. I piccoli triangoli nella parte superiore e inferiore dei plot indicano i punti che cadrebbero al di fuori della finestra di plot. Due geni con conteggi medi e variazioni logaritmiche MLE simili sono evidenziati con cerchi verdi e viola. (C) I counts, normalizzati dai size factors $s_j$, per questi geni rivelano una bassa dispersione per il gene in verde e un'alta dispersione per il gene in viola. (D) Grafici di densità delle verosimiglianze (linee intere) e dei posteriori (linee tratteggiate) per i geni verde e viola e del priore (linea nera intera): a causa della maggiore dispersione del gene viola, la sua verosimiglianza è più ampia e con un picco minore (indicando meno informazioni) e il priore ha maggiore influenza sul suo posteriore rispetto al gene verde. La maggiore curvatura del posteriore verde al suo massimo si traduce in un minore errore standard riportato per la stima MAP LFC (barra di errore orizzontale).}
    \label{fig:LFCest}
\end{figure}

Questi LFC ridotti e i loro errori standard associati vengono utilizzati nei test di Wald per l'espressione differenziale, descritti nella [sezione successiva](#testH).

La forza del restringimento non dipende semplicemente dalla media dei conteggi, ma dalla quantità complessiva di informazioni disponibili per stimare il fold change. Prendendo ad esempio, due geni con conteggi medi simili ma dispersioni diverse, questi subiranno un restringimento diverso. Tale concetto è illustrato nella figura \ref{fig:LFCest}.


<!--
Il restringimento delle stime LFC può essere descritto come un compromesso bias-varianza: per i geni con poche informazioni per la stima LFC, si acquista una riduzione della varianza forte al costo di accettare un bias verso lo zero, e questo può risultare in una riduzione complessiva dell'errore quadratico medio. 
I geni con un'elevata informazione per la stima della LFC avranno, nel nostro approccio, LFC con un basso bias e una bassa varianza. Inoltre, quando i gradi di libertà aumentano e l'esperimento fornisce maggiori informazioni per la stima della LFC, le stime rimpicciolite convergeranno verso quelle non rimpicciolite. -->



### Test di ipotesi per l'espressione differenziale {#testH}

Dopo aver adattato i modelli per ciascun gene, si procede a verificare se il coefficiente \(\beta_{ir}\) differisce significativamente da zero, con \(i\) che rappresenta il gene e \(r\) il trattamento o la condizione sperimentale. 
L'ipotesi nulla è che il trattamento non abbia alcun effetto sull'espressione del gene: \(H_0: \beta_{ir} = 0\). L'ipotesi alternativa, invece, è che il gene sia differenzialmente espresso in risposta al trattamento: \(H_1: \beta_{ir} \neq 0\). 


Per testare l'ipotesi nulla viene utilizzato il test di Wald, in cui la stima del log2 fold change \(\beta_{ir}\) viene divisa per il suo errore standard, producendo una statistica-z.
Formalmente: \(\beta_{ir} / \text{SE}(\beta_{ir})\). 

Questa statistica viene confrontata con una distribuzione normale standard (\(N(0,1)\)) per calcolare il p-value, che rappresenta la probabilità di ottenere un risultato uguale o più estremo di quello osservato, partendo dal presupposto che \(H_0\) sia vera.

- Se \(H_0\) è vera, il valore atteso della statistica-z sarà molto vicino a zero, e questa seguirà approssimativamente una distribuzione normale standard.

- Valori di \(z\) molto elevati in valore assoluto suggeriscono che l'ipotesi nulla potrebbe essere falsa. In questi casi, il p-value associato risulta piccolo e inferiore alla soglia di significatività (ad esempio 0,05). Questo porta al rifiuto di \(H_0\), indicando che il gene presenta una differenza significativa nell'espressione tra le condizioni confrontate.

\newpage


# Esempio su dataset

```{r installazione BioConductor, include=FALSE}
# per installare core pakage
# if (!require("BiocManager", quietly = TRUE))
#  install.packages("BiocManager")
# BiocManager::install()
```


```{r caricamente librerie, include=FALSE}
library(DESeq2)
library(tidyverse)
library(RColorBrewer)
library(pheatmap)
library(DEGreport)
library(gridExtra)
library(ggplot2)
library(ggrepel)
```

Vengono caricati i dati e i metadati necessari, specificando che si ha un header e che la prima colonna rappresenta i nomi delle righe.
```{r caricamento dati}
data <- read.table("Mov10_full_counts.txt", header=T, row.names=1) 
head(data)
meta <- read.table("Mov10_full_meta.txt", header=T, row.names=1)
head(meta)
```

Si vuole cercare geni che cambiano di espressione tra due o più gruppi, definiti nei metadati:

- **Mov10_oe** (over expression): gene sovraespresso artificialmente, per studiare gli effetti biologici della sovraregolazione del gene.

- **Mov10_kd** (knock down): condizione sperimentale in cui l'espressione del gene è deliberatamente ridotta per studiare i suoi effetti biologici e molecolari.

- **Irrelevant_kd**: condizione di controllo in cui le cellule sono state trattate in modo da non influenzare l'espressione di Mov10 o di altri geni.

```{r controllo gruppi}
unique(meta$sampletype)
```

## Distribuzione dei counts

Per visualizzare la distribuzione dei counts, si stampa un'istogramma per il campione ``Mov10_kd_2`` e una versione zoomata.
```{r distribuzioneCounts, warning=FALSE, fig.cap="Distribuzione dei counts di espressione grezzi.", label="distribuzioneCounts", out.width="75%", fig.align='center'}
plot1 <- ggplot(data) +
  geom_histogram(aes(x = Mov10_kd_2), stat = "bin", bins = 200) +
  xlab("Counts di espressione grezzi") +
  ylab("Numero di geni")

plot2 <- ggplot(data) +
  geom_histogram(aes(x = Mov10_kd_2), stat = "bin", bins = 200) + 
  xlim(-5, 250) + # limito asse x
  xlab("Counts di espressione grezzi") +
  ylab("Numero di geni")

# combino i plot
grid.arrange(plot1, plot2, ncol = 2)

```

In figura \@ref(fig:distribuzioneCounts) si può vedere come la distribuzione dei counts sia asimmetrica e non normale (e quindi una binomiale negativa), con molti geni con bassi conteggi.

Per controllare la relazione tra media e varianza, si calcolano media e varianza per i replicati ``Mov10_kd``.
```{r mediaVarianza, warning=FALSE, out.width="60%", fig.align = 'center', fig.cap="Relazione tra media e varianza dei counts.", label="mediaVarianza", fig.pos='h!'}
mean_counts <- apply(data[, 1:2], 1, mean)
variance_counts <- apply(data[, 1:2], 1, var)
df <- data.frame(mean_counts, variance_counts)

ggplot(df) +
        geom_point(aes(x=mean_counts, y=variance_counts)) + 
        geom_line(aes(x=mean_counts, y=mean_counts, color="red")) +
        scale_y_log10() +
        scale_x_log10()

```

In figura \@ref(fig:mediaVarianza) si nota che la varianza tra i replicati tende a essere maggiore della media (linea rossa), soprattutto per i geni con livelli di espressione medi elevati.



## Creazione oggetto DESeqDataSet

Prima di procedere con l'analisi, è buona norma controllare che i nomi dei campioni corrispondano tra i dati e i metadati.
```{r controlloCampioni}
all(colnames(data) %in% rownames(meta))
all(colnames(data) == rownames(meta))
```


Per iniziare l'analisi è necessario creare un oggetto \texttt{DESeqDataSet}, utilizzando la matrice dei counts e la tabella dei metadati. Bisogna anche specificare una formula di design, che definisce quali colonne della tabella dei metadati devono essere considerate e come devono essere utilizzate nell'analisi. Nel dataset, la colonna di interesse è \texttt{sampletype}, che contiene tre livelli di un fattore. 
Questi livelli indicano a DESeq2 di valutare, per ciascun gene, le variazioni nell'espressione genica tra le diverse condizioni sperimentali rappresentate.
```{r creazioneObj, warning=FALSE}
dds <- DESeqDataSetFromMatrix(countData = data, colData = meta, design = ~ sampletype)
```

Per visualizzare i dati, è necessario prima normalizzarli. Questo passaggio è solo per scrupolo, la funzione \texttt{DESeq()} esegue automaticamente tutti i passaggi necessari.
```{r normalizzazione}
dds_norm <- estimateSizeFactors(dds)
```

Per recuperare la matrice dei counts normalizzati, si usa la funzione \texttt{counts()} e si aggiunge l'argomento \texttt{normalized=TRUE}.
```{r countsNormalizzati}
normalized_counts <- counts(dds_norm, normalized=TRUE)
```

```{r salvataggioNorm, include=FALSE}
#write.table(normalized_counts, file="normalized_counts.txt", sep="\t", quote=F, col.names=NA)
```


### Analisi di controllo di qualità dei dati
Per migliorare le distanze/clustering per i metodi di visualizzazione PCA e di clustering gerarchico, è necessario moderare la varianza rispetto alla media applicando la trasformazione *rlog* ai counts normalizzati.
Questa funzione trasforma i dati di counts in scala logaritmica in base 2 in modo da minimizzare le differenze tra i campioni per le righe con counts piccoli. L'argomento \texttt{blind=TRUE} produce una trasformazione non influenzata dalle informazioni sulle condizioni del campione.
```{r rlog, warning=FALSE}
rld <- rlog(dds_norm, blind=TRUE)
```

#### PCA
La libreria offre una funzione built-in per plot PCA, richiede in input l'oggetto rlog e la colonna dei metadati di interesse.
```{r PCAPlot, warning=FALSE, out.width="80%", fig.align = 'center'}
plotPCA(rld, intgroup="sampletype")
```

Questa analisi delle componenti principali è accettabile, in quanto la prima componente spiega già il 73% della variazione nei dati.

#### Clustering gerarichico
Per visualizzare le correlazioni tra i campioni, bisogna calcolare la matrice di correlazione dei counts rlog.
Prima si estrae la matrice rlog dall'oggetto e poi si calcolano i valori di correlazione a coppie per i campioni.
```{r hierarchicalClustering}
rld_mat <- assay(rld) # assay() funzione caricata dalle dipendenze di DESeq2
rld_cor <- cor(rld_mat) 

head(rld_cor)
```

Valori di correlazione plottati come una heatmap.
```{r heatmapCorr, out.width="65%", fig.align = 'center', fig.cap="Heatmap delle correlazioni tra i campioni."}
heat.colors <- brewer.pal(6, "YlGn")
pheatmap(rld_cor, color = heat.colors)
```

Si osservano correlazioni elevate che suggeriscono l'assenza di campioni anomali. Analogamente al plot PCA, i campioni si raggruppano per gruppi di campioni. L'insieme di questi grafici suggerisce che i dati sono di buona qualità.

## Analisi dell'espressione differenziale
Viene utilizzato l'oggetto \texttt{DESeqDataSet} creato in precedenza. Come già ripetuto, la funzione \texttt{DESeq()} esegue tutti i passaggi ma il pacchetto offre delle singole funzioni che permettono di eseguire ogni fase del workflow in modo graduale.
```{r analisiDE}
dds_an <- DESeq(dds)
```

Si controllano i size factors stimati per ogni campione.
```{r checkSF}
sizeFactors(dds_an)
```

Numero totale di counts grezzi per ogni campione:
```{r checkCountsRaw}
colSums(counts(dds_an))
```

e numero totale di counts normalizzati per ogni campione:
```{r checCountsNorm}
colSums(counts(dds_an, normalized=T))
```

Poiché il campione è di dimensioni ridotte, per molti geni si osserva, in figura \@ref(fig:stimaDispersione) 
, un restringimento ma nel complesso i dati sono adatti al modello di DESeq2.
```{r stimaDispersione, out.width="75%", fig.cap="Stima della dispersione per ciascun gene rispetto alla media di espressione.", fig.align = 'center', label="stimaDispersione", fig.pos='h!'}
plotDispEsts(dds_an)
```


### Test di ipotesi
Come descritto nella [spiegazione](#testH) del test d'ipotesi, i coefficienti $\beta_{ir}$ ristretti rappresentano i LFC per ogni gruppo di campioni. Bisogna quindi testare se questi coefficienti sono significativamente diversi da zero, ovvero che non vi sia espressione differenziale tra i gruppi di campioni.


Per indicare a DESeq2 i due gruppi che si vogliono confrontare bisogna usare i contrasti, che vengono utilizzati per eseguire i test di espressione differenziale utilizzando il test di Wald. 


I contrasti possono essere forniti a DESeq2 in due modi diversi: 

- in modo automatico viene utilizzato il livello del fattore di base della condizione di interesse come base per i test statistici. Il livello di base viene scelto in base all'ordine alfabetico dei livelli.

- specificare il confronto di interesse e i livelli da confrontare nella funzione \texttt{results()}. Il livello indicato per ultimo è il livello di base per il confronto.


I possibili confronti a coppie sono i tre seguenti, con i primi due che sono più di interesse:

1. \texttt{controllo} vs \texttt{Mov10 overexpression}

2. \texttt{controllo} vs \texttt{Mov10 knockdown}

3. \texttt{Mov10 knockdown} vs \texttt{Mov10 overexpression}


Con i seguenti comandi vengono definiti i contrasti, viene estratta la tabella dei risultati e i LFC vengono ristretti.

```{r contrastiTest, warning=FALSE}
contrast_oe <- c("sampletype", "MOV10_overexpression", "control")

res_tableOE_unshrunken <- results(dds_an, contrast=contrast_oe)

res_tableOE <- lfcShrink(dds_an, contrast=contrast_oe, res=res_tableOE_unshrunken,
type = "normal")
```

Il nome fornito nel secondo elemento è il livello utilizzato come baseline. Ad esempio, se si osserva una variazione LFC di $-2$, significa che l'espressione genica è più bassa in ``Mov10_oe`` rispetto al \texttt{controllo}.

$~$

## Visualizzazione ed esplorazione dei risultati

Il plot MA mostra la media dei counts normalizzati rispetto ai LFC per tutti i geni analizzati. I geni che sono differenzialmente espressi in modo significativo sono colorati in blu. 

Questo plot consente di visualizzare graficamente l'effetto del restringimento della LFC, mostrando allo stesso tempo l'entità dei fold change e la loro distribuzione rispetto all'espressione media; in generale, ci si aspetta di osservare geni significativi lungo l'intera gamma dei livelli di espressione.

$~$


```{r LFC, out.width="70%", fig.align = 'center', fig.cap="Media dei counts normalizzati rispetto ai log2 fold change. I geni differenzialmente espressi sono colorati in blu.", fig.pos='h!'}
plotMA(res_tableOE_unshrunken, ylim=c(-2,2))
```

$~$

```{r LFCShrink, out.width="70%", fig.align = 'center', fig.cap="Effetto del restringimento dei LFC.", fig.pos='h!'}
plotMA(res_tableOE, ylim=c(-2,2))
```


I risultati dell'analisi sono memorizzati in un dataframe, che contiene queste colonne:

- ``baseMean``: media dei counts normalizzati per ogni campione; 

- ``log2FoldChange``: log2 fold change; 

- ``lfcSE``: standard error; 

- ``stat``: statistca Wald; 

- ``pvalue``: p-value del test di Wald; 

- ``padj``: p-value aggiustato BH.

```{r risultatiDEA}
res_tableOE
```

È fondamentale aggiustare i p-value per controllare il tasso di falsi positivi (False Discovery Rate). Questo viene realizzato tramite il metodo di Benjamini-Hochberg (BH), che ordina i geni in base ai loro p-value e moltiplica ciascun p-value ordinato per il rapporto \( m/\text{rank} \), dove \( m \) rappresenta il numero totale di test eseguiti e \(\text{rank}\) la posizione del gene nell'ordinamento.


La funzione \texttt{summary()} fornisce un riassunto dei risultati dell'analisi.
```{r riassuntoDEA}
summary(res_tableOE)
```

Oltre al numero di geni up- e down-regolati, la funzione riporta anche il numero di geni che sono stati testati (geni con read counts totale non nullo) e il numero di geni non inclusi nella correzione dei test multipli a causa di counts medio basso.

I geni up-regolati (LFC > 0) sono quelli il cui livello di espressione è aumentato significativamente nel gruppo ``MOV10_overexpression`` rispetto al ``controllo`` e sono il 18% del totale.
I geni down-regolati (LFC < 0) sono quelli il cui livello di espressione è diminuito significativamente e sono il 19%.


Prima di estrarre i geni significativamente espressi, si aggiunge una soglia di FDR e LFC per ridurre il numero di geni significativi.

```{r soglie}
# setto soglie
padj_cutoff <- 0.05
lfc_cutoff <- 0.58
```

Il valore di ``lfc_cutoff`` è impostato su 0,58, questo si traduce in un incremento di circa 1,5 volte nell'espressione ($2^{0.58}\approx1.5$). Considero quindi solo quei geni che mostrano un incremento o una  diminuzione di almeno il 50% rispetto al controllo.

Per selezionare i geni significativi, si utilizza la funzione \texttt{filter()} della libreria dplyr per estrarre i geni usando le soglie definite sopra.
```{r selezioneGeniSignificativi}
sigOE <- res_tableOE %>%
  data.frame() %>%
  rownames_to_column(var="gene") %>% 
  as_tibble() %>%
  filter(padj < padj_cutoff & abs(log2FoldChange) > lfc_cutoff)
```

I risultati vengono ridotti, da 23368 a 870 geni significativi.
```{r geniSignificativi}
sigOE %>%
  arrange(padj)
```


```{r upDownReg}
sigOE %>%
  count(log2FoldChange > 0) %>%
  mutate(percentuale = n/sum(n)*100)
```

Ora la percentuale dei geni up-regolati è del 77%, mentre quella dei geni down-regolati è del 23%. Questo suggerisce che la sovraregolazione del gene ha un effetto più forte sull'espressione genica rispetto alla sua repressione.


Come plot finale, si esaminano le read counts normalizzate per un singolo gene nei vari gruppi; per fare ciò si sceglie il gene che ha il p-value più piccolo.

```{r plotCounts, out.width="65%", fig.align = 'center', fig.cap="Counts per il gene con il p-value più piccolo.", fig.pos='h!'}
name <- sigOE$gene[which.min(sigOE$padj)]
pc <- plotCounts(dds_norm, gene=name, intgroup="sampletype", returnData = TRUE)

ggplot(pc, aes(x = sampletype, y = count, color = sampletype)) + 
  geom_point(position=position_jitter(w = 0.1,h = 0)) +
  geom_text_repel(aes(label = rownames(pc))) + 
  theme_bw() +
  ggtitle(name) +
  theme(plot.title = element_text(hjust = 0.5)) # per centrare il titolo
```

L'espressione del gene è significativamente più alta nel gruppo ``MOV10_overexpression``, questo suggerisce un'efficace sovraregolazione del gene. Nei gruppi ``Control`` e ``MOV10_knockdown``, l'espressione del gene è trascurabile, indicando che il knockdown è riuscito e che non sono presenti livelli significativi di espressione anche nel controllo.
Il plot quindi evidenzia una chiara differenza nell'espressione del gene tra i tre gruppi, supportando il successo delle condizioni sperimentali.


# Acronimi

**BH** Benjamini-Hochberg

**cDNA** DNA complementare

**FDR** False Discovery Rate

**GLM** Generalized Linear Model

**LFC** Log Fold Change

**MAP** Maximum A Posteriori

**mRNA** RNA messaggero

**MLE** Maximum Likelihood Estimate

**PCA** Principal Component Analysis

**RNA-seq** RNA sequencing


# Riferimenti
